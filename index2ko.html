<html>

<head>
    <title>FullCalendar POC</title>
    <link href='./node_modules/fullcalendar/dist/fullcalendar.min.css' rel='stylesheet' />
    <link href='./node_modules/fullcalendar/dist/fullcalendar.print.min.css' rel='stylesheet' media='print' />
    <link href="./node_modules/fullcalendar-scheduler/dist/scheduler.min.css" rel="stylesheet" />
    <link href="./node_modules/jquery-ui-dist/jquery-ui.css" rel="stylesheet" />

    <script src="./node_modules/requirejs/require.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.css" rel="stylesheet" type="text/css"/> -->

    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/js/bootstrap-datepicker.js"></script> -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>  -->
    <!-- <script src='./node_modules/moment/min/moment.min.js'></script>
    <script src='./node_modules/jquery/dist/jquery.min.js'></script>
    <script src='./node_modules/fullcalendar/dist/fullcalendar.min.js'></script>
    <script src='./node_modules/fullcalendar-scheduler/dist/scheduler.min.js'></script>
    <script src='./node_modules/jquery-ui-dist/jquery-ui.js'></script>    
    <script src='./node_modules/bootstrap/dist/js/bootstrap.js'></script> -->

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Lucida Grande", Helvetica, Arial, Verdana, sans-serif;
            font-size: 14px;
        }

        #calendar {
            max-width: 900px;
            margin: 50px auto;
        }
    </style>
</head>

<body>

    <script>
        require.config({
            paths: {
                "moment": "./node_modules/moment/min/moment.min",
                "jquery": "./node_modules/jquery/dist/jquery",
                "knockout": "./node_modules/knockout/build/output/knockout-latest",
                "fullcalendar": "./node_modules/fullcalendar/dist/fullcalendar",
                "scheduler": "./node_modules/fullcalendar-scheduler/dist/scheduler",
                "jqueryui": "./node_modules/jquery-ui-dist/jquery-ui",
                // "popper": "./popper",
                // "bootstrap": "./node_modules/bootstrap/dist/js/bootstrap",
                // "bootstrap-datepicker": "./node_modules/bootstrap-datepicker/dist/js/bootstrap-datepicker.min"
            }
        });

        require(['knockout', 'jquery', 'data', 'moment', 'fullcalendar', 'scheduler', 'jqueryui'
            //    'popper', 'bootstrap', 'bootstrap-datepicker'
        ],
            function (ko, $, data) {

                var appointmentViewModel = {
                    title: ko.observable("omkar"),
                    appointmentData: data.appointmentObj
                };

                var viewModel = {
                    buildings: data.buildings,

                    loadCalendar: function () {
                        $('#calendar').fullCalendar({
                            defaultDate: '2018-04-01',
                            editable: true,
                            navLinks: false,
                            eventLimit: true, // allow "more" link when too many events   
                            weekNumbers: true,
                            header: {
                                left: 'today prev,next',
                                center: 'title',
                                right: 'timelineMonth'
                            },
                            defaultView: 'timelineMonth',
                            resourceAreaWidth: '25%',
                            resourceLabelText: 'Rooms',
                            
                            resourceColumns: [
                                {
                                    group: true,
                                    labelText: 'Building',
                                    field: 'building'
                                },
                                {
                                    labelText: 'Apartment',
                                    field: 'title'
                                }
                            ],
                            resources: data.buildingResource(),
                            // eventRender: function (resource, cellEls) {
                            //     cellEls.on('click', function () {
                            //         if (confirm('Are you sure you want to delete ' + resource.title + '?')) {

                            //         }
                            //     });
                            // },

                            events: data.newevents,
                            eventMouseover: function (data, event, view) {

                                tooltip = '<div class="tooltiptopicevent" style="width:auto;height:auto;background:#ccc;position:absolute;z-index:10001;padding:10px 10px 10px 10px ;  line-height: 200%;">' + 'title: ' + ': ' + data.title + '</br>' + 'start: ' + ': ' + data.start + '</div>';

                                $("body").append(tooltip);
                                $(this).mouseover(function (e) {
                                    $(this).css('z-index', 10000);
                                    $('.tooltiptopicevent').fadeIn('500');
                                    $('.tooltiptopicevent').fadeTo('10', 1.9);
                                }).mousemove(function (e) {
                                    $('.tooltiptopicevent').css('top', e.pageY + 10);
                                    $('.tooltiptopicevent').css('left', e.pageX + 20);
                                });

                            },
                            eventMouseout: function (data, event, view) {
                                $(this).css('z-index', 8);

                                $('.tooltiptopicevent').remove();

                            },
                            eventClick: function (eventObj, isCreate) {
                                openAppointmentDialog(eventObj.title, eventObj.start, eventObj.end, eventObj, false);
                                $('.ui-dialog-buttonpane button:contains("Delete Appoinment")').button().show();
                            },
                            dayClick: function (date, jsEvent, view, resourceObj, isCreate, cellEls) {
                                openAppointmentDialog(resourceObj.title, date, date, resourceObj, true);
                                $('.ui-dialog-buttonpane button:contains("Delete Appoinment")').button().hide();
                            },
                            selectable: true,
                            select: function (startDate, endDate, jsEvent, view, resource, isCreate, cellEls) {
                                openAppointmentDialog(resource.title, startDate, endDate, resource, true);
                                $('.ui-dialog-buttonpane button:contains("Delete Appoinment")').button().hide();
                            },
                            schedulerLicenseKey: 'GPL-My-Project-Is-Open-Source'
                        });
                    },

                };
                ko.applyBindings(viewModel, document.getElementById('demoCalendar'));


                removeAppointment = function (id) {
                    $('#calendar').fullCalendar('removeEvents', function () { return true; });
                   var index = data.newevents.findIndex(function(item){return item.id == id;});
                    data.newevents.splice(index,1);
                    $('#calendar').fullCalendar('addEventSource', data.newevents, true);
                };

                saveAppointments = function (stitle, sDate, eDate, sbuildingId, sresourceId) {
                    $('#calendar').fullCalendar('removeEvents', function () { return true; });
                    data.newevents.push
                        ({ id: data.newevents.length + 1, resourceId: sresourceId, start: sDate, end: eDate, title: stitle, buildingid: sbuildingId, eventColor: 'red' });

                    $('#calendar').fullCalendar('addEventSource', data.newevents, true);
                };

                saveRecurringAppointments = function (aptObj, resObj) {
                    $('#calendar').fullCalendar('removeEvents', function () { return true; });
                    if (aptObj.repeat() == true && aptObj.occurences() > 1) {
                        for (let index = 0; index < aptObj.occurences(); index++) {
                            const element = array[index];
                        }
                    }
                    data.newevents.push
                        ({ id: data.newevents.length + 1, resourceId: sresourceId, start: sDate, end: eDate, title: stitle, buildingid: sbuildingId, eventColor: 'red' });

                    $('#calendar').fullCalendar('addEventSource', data.newevents, true);
                };

                openDeleteAppointmentDialog = function (resource, cellEls) {
                    $("#deleteDialog").dialog({
                        resizable: false,
                        height: "auto",
                        width: 400,
                        modal: true,
                        buttons: [
                            {
                                text: 'Delete Appoinment',
                                click: function () {

                                    // var apptObj = appointmentViewModel.appointmentData;
                                    // saveAppointments(apptObj.pName(), apptObj.startDate().format(), apptObj.endDate().format(), resource.buildingid, resource.id)

                                    $(this).dialog('close')
                                },
                                class: 'btn btn-secondary'
                            },
                            {
                                text: 'Cancel',
                                click: function () {
                                    $(this).dialog('close')
                                },
                                class: 'btn btn-secondary'
                            }],

                    });
                }

                openAppointmentDialog = function (title, sDate, eDate, resource, isCreate) {
                    $("#dialog").css("display","inline");
                    $("#dialog")
                        .dialog({
                            resizable: false,
                            height: "auto",
                            width: 400,
                            modal: true,
                          
                            buttons: [
                                {
                                    text: 'Save Changes',
                                    click: function () {

                                        var apptObj = appointmentViewModel.appointmentData;
                                        saveAppointments(apptObj.pName(), apptObj.startDate(), apptObj.endDate(), resource.buildingid, resource.id)

                                        $(this).dialog('close')
                                    },
                                    // class: 'btn btn-primary'
                                    class: 'btn btn-secondary'
                                },
                                {
                                    text: 'Cancel',
                                    click: function () {
                                        $(this).dialog('close')
                                    },
                                    class: 'btn btn-secondary'
                                }, {
                                    text: 'Delete Appoinment',
                                    click: function () {

                                        if (confirm('Are you sure you want to delete ' + resource.title + '?')) {
                                            removeAppointment(resource.id);
                                        }
                                        $(this).dialog('close')
                                    },
                                    class: 'btn btn-secondary'
                                }
                            ],

                            create: function () {
                                ko.applyBindings(appointmentViewModel, $("#dialog")[0]);
                            },
                            open: function () {
                                if (isCreate) {
                                    appointmentViewModel.appointmentData.pName("");
                                    
                                } else {
                                    appointmentViewModel.appointmentData.pName(title);
                                }
                                appointmentViewModel.appointmentData.apartmentName("");
                                var startDate = new Date(sDate);
                                var startDatestring = startDate.getFullYear() + "-" + ("0" + (startDate.getMonth() + 1)).slice(-2) + "-" + ("0" + startDate.getDate()).slice(-2);
                                appointmentViewModel.appointmentData.startDate(startDatestring);
                                var endDate = new Date(eDate);
                                var endDatestring = endDate.getFullYear() + "-" + ("0" + (endDate.getMonth() + 1)).slice(-2) + "-" + ("0" + endDate.getDate()).slice(-2);
                                appointmentViewModel.appointmentData.endDate(endDatestring);

                            }
                        });
                };

                $(document).ready(function () {
                    viewModel.loadCalendar();

                    $("#create-appointment").button().on("click", function () {
                        //  $('#dialog').dialog();
                        openAppointmentDialog();
                    });
                   $("#dialog").css("display","none");
                });
            });


    </script>

    <div id="demoCalendar">        
        <!-- <p>
            Building List:
            <select data-bind="options: buildings, optionsText: 'name',optionsCaption: 'Choose...'"></select> 
            <button id="create-appointment" class="btn btn-secondary">Create new appointment</button>
        </p> -->
        <div id="calendar"></div>
    </div>

    <div id="dialog" title="Book An Appointment">
        <fieldset>
            <div class="modal-body" data-bind="with: appointmentData">
                <div class="form-group">
                    <label data-bind="text: apartmentName" id="infoApartment" class="col-form-label"></label>
                </div>

                <div class="form-group">
                    <label for="personName" class="col-form-label">Person Name:</label>
                    <input data-bind="value:pName" type="text" class="form-control" id="personName">
                </div>

                <div class="form-group">
                    <label for="startDate" class="col-form-label">Start Date:</label>
                    <input type="date" data-bind="value: startDate" class="form-control" id="startDate">
                </div>

                <div class="form-group">
                    <label class="col-form-label">End Date:</label>
                    <input type="date" data-bind="value: endDate" class="form-control">
                </div>


            </div>
        </fieldset>
    </div>

    <div id="deleteDialog" class="modal hide fade">
        <div class="modal-body">
            Are you sure?
        </div>
        <!-- <div class="modal-footer">
            <button type="button" data-dismiss="modal" class="btn btn-primary" id="delete">Delete</button>
            <button type="button" data-dismiss="modal" class="btn">Cancel</button>
        </div> -->
    </div>

</body>

</html>